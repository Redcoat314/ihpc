(function(j){function A(a,b,c){c.nostyle||a.css({position:"relative"});a.data("nailthumb.originalImageDims")||a.css({width:"auto",height:"auto",top:0,left:0}).removeAttr("width").removeAttr("height");B(b,c);var d,e;if(a.data("nailthumb.originalImageDims"))e=a.data("nailthumb.originalImageDims");else if(e=v(a),a.data("nailthumb.originalImageDims",e),!c.keepImageDimensions)a.one("load",function(){a.data("nailthumb.originalImageDims",null)});d=e;m("image",a);m("imageDims",d);if(0==d.width||0==d.height){e= null;d=0;for(var g;g=a[d++];){var h=j(g).parents().andSelf().filter(":hidden");if(h.length){var r=[];h.each(function(){var a=j(this).attr("style"),a="undefined"==typeof a?"":a;r.push(a);j(this).attr("style",a+" display: block !important;")});h.eq(0).css("left",-1E4);g=h.eq(0).clone();j("body").append(g);e=w(g);h.each(function(){j(this).attr("style",r.shift())});g.remove()}else e=w(g)}d=e;m("imageCloneDims",d)}e=C(b,c);m("container",b);m("containerDims",e);null!=c.proportions&&0<c.proportions?g=c.proportions: (h=e.innerWidth/d.width,c.method&&"resize"==c.method?e.innerHeight/d.height<h&&(h=e.innerHeight/d.height):e.innerHeight/d.height>h&&(h=e.innerHeight/d.height),c.maxEnlargement&&c.maxEnlargement<h&&(h=c.maxEnlargement),c.maxShrink&&c.maxShrink>h&&(h=c.maxShrink),g=h);s("proportions",g);h=d.width*g;g*=d.height;var t=0,f=0,l,k,n=c.fitDirection;k={h:"center",v:"center"};n&&(n=n.split(" "),0<n.length&&(k=D(n[0],k)),1<n.length&&(k=D(n[1],k)));if(g<e.innerHeight)switch(k.v){case "center":t=-(g-e.innerHeight)/ 2;break;case "bottom":t=-(g-e.innerHeight);l="bottom";break;case "top":t=0,l="top"}else if(g>e.innerHeight)switch(k.v){case "center":t=-(g-e.innerHeight)/2;break;case "bottom":t=-(g-e.innerHeight)}if(h<e.innerWidth)switch(k.h){case "center":f=-(h-e.innerWidth)/2;break;case "right":f=-(h-e.innerWidth)}else if(h>e.innerWidth)switch(k.h){case "center":f=-(h-e.innerWidth)/2;break;case "right":f=-(h-e.innerWidth)}a.addClass(c.imageClass);if(a.data("nailthumb.replaceto")){k=a.data("nailthumb.replaceto"); var p=null;k.find("img").each(function(){!p&&!j(this).data("nailthumb.replaceto")&&(p=j(this))});n=p;a.data("nailthumb.replacing",!0);a.load(function(){a.data("nailthumb.replacing",null)});n?n.replaceWith(a):k.append(a);c.afterReplace&&c.afterReplace(b,a,c)}F(a,d,b,e,g,h,f,t,l,c)}function G(a,b){var c=j("<img />").attr("src",b.imageUrl).css("display","none").data("nailthumb.replaceto",a);a.append(c);return c}function H(a){var b,c=a.find("a").first();0==c.length&&a.is("a")&&(c=a);c.attr("href")&&(b= j("<img />").attr("src",c.attr("href")).css("display","none").data("nailthumb.replaceto",c),c.attr("title")&&b.attr("title",c.attr("title")),c.append(b));return b}function B(a,b){b.containerClass&&a.addClass(b.containerClass);b.nostyle||a.css({overflow:"hidden",padding:"0px"});"animate"==b.replaceAnimation?(b.width||b.height)&&a.animate({width:b.width,height:b.height},b.animationTime,b.animation):(b.width&&a.width(b.width),b.height&&a.height(b.height));a.find("span."+b.titleClass).remove()}function F(a, b,c,d,e,g,h,j,m,f){"animate"==f.replaceAnimation?(a.css("display","inline"),c.animate({width:d.innerWidth,height:d.innerHeight},f.animationTime,f.animation),a.animate({width:g,height:e,top:j,left:h},f.animationTime,f.animation,function(){q(a,b,c,d,e,g,h,j,m,f)})):(c.css({width:d.innerWidth,height:d.innerHeight}),f.replaceAnimation&&a.css("display","none"),a.css({width:g,height:e,top:j,left:h}),"fade"==f.replaceAnimation?a.fadeIn(f.animationTime,f.animation,function(){q(a,b,c,d,e,g,h,j,m,f)}):"slide"== f.replaceAnimation?a.slideDown(f.animationTime,f.animation,function(){q(a,b,c,d,e,g,h,j,m,f)}):f.replaceAnimation&&f.replaceAnimation instanceof Function?(f.replaceAnimation(a,function(){q(a,b,c,d,e,g,h,j,m,f)},f),f.selfStartAfterAppear||q(a,b,c,d,e,g,h,j,m,f)):(a.css("display","inline"),q(a,b,c,d,e,g,h,j,m,f)))}function q(a,b,c,d,e,g,h,r,t,f){f.afterAppear&&f.afterAppear(c,a,f);a.data("nailthumb.replaceto",null);var l=d;if(f.title||f.titleAttr&&a.attr(f.titleAttr))if(d=f.title?f.title:a.attr(f.titleAttr)){var k= j('<span class="'+f.titleClass+'">'+d+"</span>");l.innerHeight>e?k.css("top",l.innerHeight-e):k.css("top","0px");c.append(k);var n=v(k);d=v(a);m("decorate containerDims",l);m("decorate imageDims",b);m("decorate imageDims",d);m("decorate tit",n);var p=l.offsetTop+l.innerHeight-n.offsetTop;l.height>l.innerHeight&&(p+=(l.height-l.innerHeight)/2);k.css("top","+="+p);g<n.width&&k.css("width",g);0<h&&k.css("left",h);var u=n.height;l.innerHeight>e&&"bottom"!=t&&(u+=(l.innerHeight-e)/("top"==t?1:2));b=k.clone(); b.css("width","auto").css("display","none").css("position","absolute");c.append(b);var q=v(b);b.remove();m("decorate cloneDims",q);"hover"==f.titleWhen?c.unbind("mouseenter mouseleave").hover(function(){k.find("span."+f.titleScrollerClass).css("left",0);l=v(c);n=v(k);p=l.offsetTop+l.innerHeight-n.offsetTop;l.height>l.innerHeight&&(p+=(l.height-l.innerHeight)/2);m("decorate hover tit",n);s("decorate hover outbound",n);var a=0;0>p?(k.css("top","+="+p),a=u):a=u-p;f.animateTitle?(x(k,f),k.stop(!0).animate({top:"-="+ a},f.titleAnimationTime,f.titleAnimation,function(){y(k,q.width,l.innerWidth,f)})):(k.css({top:"-="+a}),y(k,q.width,l.innerWidth,f))},function(){f.animateTitle?(x(k,f),k.animate({top:"+="+u},f.titleAnimationTime,f.titleAnimation,function(){x(k,f)})):(x(k,f),k.css({top:"+="+u}))}):f.animateTitle?k.animate({top:"-="+u},f.titleAnimationTime,f.titleAnimation,function(){y(k,q.width,l.innerWidth,f)}):(k.css({top:"-="+u}),y(k,q.width,l.innerWidth,f))}if(f.onFinish)f.onFinish(c,f);f.loadingClass&&c.removeClass(f.loadingClass); a.data("nailthumb.working",null)}function x(a,b){a.find("span."+b.titleScrollerClass).stop()}function y(a,b,c,d){b>c&&d.titleScrolling&&(0==a.find("span."+d.titleScrollerClass).length&&(a.wrapInner('<span class="'+d.titleScrollerClass+'" />'),a.find("span."+d.titleScrollerClass).width(b).css("position","relative").css("white-space","nowrap")),a.find("span."+d.titleScrollerClass).css("left",0),setTimeout(E(a,b,c,d),1E3))}function E(a,b,c,d){return function(){var e=Number(a.find("span."+d.titleScrollerClass).css("left").replace(/[^-\d]/g, ""));s("indent",e);s("width",b);s("visibleWidth",c);s("width <= -indent",b<=-e);e=b+e;0>=e&&(a.find("span."+d.titleScrollerClass).css("left",c),e=b+c);e+=10;a.find("span."+d.titleScrollerClass).animate({left:"-="+e},1E3*b/30,"linear",E(a,b,c,d))}}function D(a,b){switch(a){case "top":b.v="top";break;case "bottom":b.v="bottom";break;case "left":b.h="left";break;case "right":b.h="right"}return b}function C(a,b){var c=v(a);b.width&&(c.innerWidth=b.width);b.height&&(c.innerHeight=b.height);return c}function w(a){var b= j(a).offset();return{offsetTop:b.top,offsetLeft:b.left,width:j(a).outerWidth(),height:j(a).outerHeight(),innerWidth:j(a).innerWidth(),innerHeight:j(a).innerHeight()}}function v(a){for(var b=null,c=0,d;d=a[c++];){var e=j(d).parents().andSelf().filter(":hidden");if(e.length){var g=[];e.each(function(){var a=j(this).attr("style"),a="undefined"==typeof a?"":a;g.push(a);j(this).attr("style",a+" display: block !important;")});e.eq(0).css("left",-1E4);b=w(d);e.each(function(){j(this).attr("style",g.shift())})}else b= w(d)}return b}function s(a,b,c){try{(z&&window.console&&window.console.log||c)&&window.console.log(a+": "+b)}catch(d){}}function m(a,b,c){try{b||(b=a),s(a,b),(z&&window.console&&window.console.log||c)&&window.console.debug(b)}catch(d){}}var z=!1;j.fn.nailthumb=function(a){var b=j.extend({},j.fn.nailthumb.defaults,a);return this.each(function(){var a=j(this),d=j.metadata?j.extend({},b,a.metadata()):b,e,g=a.find("img").first(),h=d.imageCustomFinder;!h&&d.imageUrl?h=G:!h&&d.imageFromWrappingLink&&(h= H);h&&(h=h(a,d),m("finder",h),h||(h=[]),0<h.length&&(g=h,g.css("display","none"),g.data("nailthumb.replaceto")||g.data("nailthumb.replaceto",a),g.data("nailthumb.originalImageDims",null)));0==g.length&&a.is("img")&&(g=a);e=g;var r,g=a;a.is("img")&&(d.ifImageAddContainer&&(g=j("<div></div>"),a.wrap(g)),g=a.parent());r=g;d.serverSideParams&&j.fn.nailthumb.setServerSideParams(e,r,d);m("image",e);m("container",r);if(d.onStart)d.onStart(r,d);d.loadingClass&&r.addClass(d.loadingClass);d.preload||e.data("nailthumb.replaceto")? (s("wait on load"),e.one("load",function(){m("before check",e);!e.data("nailthumb.working")&&!e.data("nailthumb.replacing")&&(e.data("nailthumb.working",!0),m("inside check",e),A(e,r,d))}),a=e.attr("src"),e.attr("src",null).attr("src",a)):(s("nail thumb directly"),e.data("nailthumb.working",!0),A(e,r,d))})};j.fn.nailthumb.evalServerSideParams=function(a,b,c){if(c.serverSideParams){var d={};if(!c.serverSideParams.noServerResize){var e=a=null;c.serverSideParams.width?a=c.serverSideParams.width:c.width&& (a=c.width);c.serverSideParams.height?e=c.serverSideParams.height:c.height&&(e=c.height);if(!a||!e)B(b,c),b=C(b,c),a=b.innerWidth,e=b.innerHeight;a&&e&&(d.w=a,d.h=e,"resize"!=c.serverSideParams.mode&&("crop"==c.method&&(d.mode="crop"),c.serverSideParams.mode&&(d.mode=c.serverSideParams.mode)))}j.each(c.serverSideParams,function(a,b){"width"!=a&&("height"!=a&&"mode"!=a&&"noServerResize"!=a&&b)&&(d[a]=b)});var g="";j.each(d,function(a,b){g+=";"+a+"="+b});s(g,d);return g}return""};j.fn.nailthumb.setServerSideParams= function(a,b,c){if(c.serverSideParams){var d=a.attr("src");a.data("nailthumb.originalImageUrl")&&(d=a.data("nailthumb.originalImageUrl"));a.data("nailthumb.originalImageUrl",d);b=j.fn.nailthumb.evalServerSideParams(a,b,c);a.attr("src",d+b)}};j.fn.nailthumb.toggleDebug=function(){z=!z};j.fn.nailthumb.doThumb=function(a,b,c){A(a,b,c)};j.fn.nailthumb.defaults={onStart:null,onFinish:null,loadingClass:"nailthumb-loading",imageUrl:null,imageFromWrappingLink:!1,imageCustomFinder:null,imageClass:"nailthumb-image", afterReplace:null,afterAppear:null,replaceAnimation:"fade",selfStartAfterAppear:!1,animationTime:1E3,animation:"swing",keepImageDimensions:!1,method:"crop",fitDirection:null,proportions:null,ifImageAddContainer:!0,containerClass:"nailthumb-container",maxEnlargement:null,maxShrink:null,preload:!0,nostyle:!1,width:null,height:null,title:null,titleClass:"nailthumb-title",titleAttr:"title",titleWhen:"hover",titleScrolling:!0,titleScrollerClass:"nailthumb-title-scroller",animateTitle:!0,titleAnimationTime:500, titleAnimation:"swing",serverSideParams:null}})(jQuery);